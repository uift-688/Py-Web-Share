<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Share</title>
</head>
<body>
    <h1>QR Share</h1>
    <button onclick="html5QrCode.start({ facingMode: 'environment' }, { fps: 10, qrbox: 250 }, onScanSuccess, onScanError)">スキャン&ダウンロード</button>
    <canvas id="qrcodeCanvas"></canvas>
    <input type="file" id="fileInput">
    <button onclick="generateQRCode()">共有</button>
    <button id="downloadButton">ダウンロード</button>

    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <script>
        // QRコード生成関数
        function generateQRCode() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = btoa(
                        new Uint8Array(e.target.result)
                            .reduce((data, byte) => data + String.fromCharCode(byte), '')
                    );
                    const mimeType = file.type;
                    const dataURL = `data:${mimeType};base64,${base64String}`;
                    const qrcodeCanvas = document.getElementById('qrcodeCanvas');
                    QRCode.toCanvas(qrcodeCanvas, dataURL, function (error) {
                        if (error) console.error(error);
                        console.log('QR code generated successfully.');
                    });
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // QRコードスキャナーを初期化する
        const html5QrCode = new Html5Qrcode("qrcodeCanvas");

        // スキャン成功時の処理
        function onScanSuccess(decodedText, decodedResult) {
            document.getElementById("downloadButton").addEventListener("click", function() {
                const link = document.createElement("a");
                link.href = decodedText;
                link.download = "qr-code-data";
                link.click();
            });
        }

        // スキャンエラー処理
        function onScanError(errorMessage) {
            console.log("QR Code Scan Error: ", errorMessage);
        }
    </script>
</body>
</html>
